<!DOCTYPE html>
<html>
<head>
    <title>Simple WebChat Test</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>
    <h2>Simple Connection Test</h2>
    <div>
        <input type="text" id="username" placeholder="Your name" value="TestUser">
        <button onclick="createPeer()">Create Peer</button>
        <span id="myId"></span>
    </div>
    <div>
        <input type="text" id="targetId" placeholder="Target Peer ID">
        <button onclick="connectToPeer()">Connect</button>
    </div>
    <div>
        <input type="text" id="message" placeholder="Test message">
        <button onclick="sendMessage()">Send</button>
    </div>
    <div id="status" style="font-family: monospace; white-space: pre-line;"></div>

    <script>
        let peer, conn;
        
        function log(msg) {
            const status = document.getElementById('status');
            status.textContent += new Date().toLocaleTimeString() + ': ' + msg + '\n';
            status.scrollTop = status.scrollHeight;
            console.log(msg);
        }
        
        function createPeer() {
            const username = document.getElementById('username').value;
            const peerId = username + '-' + Math.floor(Math.random()*9999);
            
            peer = new Peer(peerId, {
                host: '0.peerjs.com',
                port: 443,
                secure: true,
                debug: 0,
                config: {
                    'iceServers': [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { 
                            urls: 'turn:openrelay.metered.ca:80',
                            username: 'openrelayproject',
                            credential: 'openrelayproject'
                        }
                    ]
                }
            });
            
            peer.on('open', (id) => {
                log('âœ… Peer created: ' + id);
                document.getElementById('myId').textContent = 'Your ID: ' + id;
            });
            
            peer.on('connection', (connection) => {
                log('ğŸ“ Incoming connection from: ' + connection.peer);
                setupConnection(connection);
            });
            
            peer.on('error', (err) => {
                log('âŒ Peer error: ' + err.type + ' - ' + err.message);
            });
        }
        
        function connectToPeer() {
            const targetId = document.getElementById('targetId').value.trim();
            if (!peer || !targetId) {
                log('âŒ Need peer and target ID');
                return;
            }
            
            log('ğŸ”„ Connecting to: ' + targetId);
            conn = peer.connect(targetId);
            setupConnection(conn);
        }
        
        function setupConnection(connection) {
            conn = connection;
            
            conn.on('open', () => {
                log('âœ… Connection established with: ' + conn.peer);
                // Send simple handshake
                conn.send({ type: 'handshake', name: peer.id, timestamp: Date.now() });
            });
            
            conn.on('data', (data) => {
                log('ğŸ“¨ Received: ' + JSON.stringify(data));
                if (data.type === 'handshake') {
                    log('ğŸ¤ Handshake from: ' + data.name);
                    conn.send({ type: 'handshake_ack', name: peer.id });
                }
            });
            
            conn.on('error', (err) => {
                log('âŒ Connection error: ' + err);
            });
            
            conn.on('close', () => {
                log('ğŸ”Œ Connection closed');
            });
        }
        
        function sendMessage() {
            const msg = document.getElementById('message').value.trim();
            if (!conn || !msg) {
                log('âŒ Need connection and message');
                return;
            }
            
            if (!conn.open) {
                log('âŒ Connection not open');
                return;
            }
            
            conn.send({ type: 'message', text: msg, from: peer.id, timestamp: Date.now() });
            log('ğŸ“¤ Sent: ' + msg);
            document.getElementById('message').value = '';
        }
    </script>
</body>
</html>
